#!/bin/sh
# script to set the keymap properly in grub2
# includes bundled ckbcomp perl script in repo from AUR unlikely to change much
# heavily inspired by fitzcarraldoblog cheers 
# assumes standard /boot/ 

KB_LAYOUT="be"
KB_VARIANT="nodeadkeys"

GRUB_DEF="/etc/default/grub"
GRUB_LAY="/boot/grub/layouts"
BOOT_DIR="/boot/efi"
GRUB_CFG="/boot/grub/grub.cfg"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
LOCALE=$(locale | grep "^LANG=" | sed 's/LANG=//; s/\.UTF-8.*//')

# Check if running as root
if [[ $EUID -ne 0 ]]; then
    echo "This script must be run as root (use sudo)"
    exit 1
fi

### S1 ckbcomp
# Use bundled ckbcomp script
CKBCOMP="$SCRIPT_DIR/lib/ckbcomp"

# Check if bundled ckbcomp exists
if [ ! -f "$CKBCOMP" ]; then
    echo "Error: ckbcomp not found at $CKBCOMP"
    exit 1
else
    chmod +x "$CKBCOMP"
fi
## Made a kb validator using xkeyboard-config layout usually generated at /usr/share/X11/xkb/symbols
## Simply checks layout and variant are correct
"$SCRIPT_DIR/lib/symap_main.py" $KB_LAYOUT $KB_VARIANT || { echo "Error: Invalid keyboard layout or variant"; exit 1; } 

### S2 prepare files for grub
mkdir -p $GRUB_LAY
### S2.1 gen layout compatible with grub
# this might generate a bunch of errors since grub only supports 1-127. but this is fine for alphanurmeric encryption passwords
# no language specific chars in pw
"$CKBCOMP" $KB_LAYOUT $KB_VARIANT | grub-mklayout -o $GRUB_LAY/$KB_LAYOUT.gkb

if [ -f $GRUB_LAY/$KB_LAYOUT.gkb ]; then
    echo "Successfully generated layout file"
else
    echo "Failed to generate layout file"
    exit 1
fi
### S3 modify /etc/default/grub files
if grep -q "GRUB_TERMINAL_INPUT.*console" $GRUB_DEF; then
    echo "Found console setting, replacing..."
    sed -i 's/=console/=at_keyboard/g' $GRUB_DEF
else
    echo "Console setting not found or already modified"
    exit 1
fi
## Can also be added to 00_header
if ! grep -q "insmod keylayouts" /etc/grub.d/40_custom; then
    echo "Adding mods to grub 40__custom"
    tee -a /etc/grub.d/40_custom << EOF
insmod keylayouts
keymap \$prefix/layouts/$KB_LAYOUT.gkb
EOF
else 
    echo "40__custom not found or already modified"
    exit 1
fi

### S4 modify some more and apply
# Add to GRUB if not already there
if ! grep -q "locale=$LOCALE" $GRUB_DEF; then
    sed -i "s/GRUB_CMDLINE_LINUX_DEFAULT=\"/&locale=$LOCALE /" $GRUB_DEF
else 
    echo "Locale setting not found or already modified"
    exit 1
fi
# regen config
grub-mkconfig -o $GRUB_CFG
